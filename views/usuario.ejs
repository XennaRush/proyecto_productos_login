<%- include("templates/header", { titulo: titulo || "Catálogo de Productos" }) %>

<div class="alert alert-info">Selecciona los productos que deseas comprar.</div>

<div class="mb-3">
  <a href="/usuario/historial" class="btn btn-outline-info">Ver mi historial de compras</a>
</div>

<table class="table table-hover align-middle">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Stock disponible</th>
      <th>Categoría</th>
      <th>Imagen</th>   <!-- NUEVO -->
      <th>Comprar</th>
    </tr>
  </thead>
  <tbody>
    <% if (productos.length === 0) { %>
      <tr><td colspan="6" class="text-center">No hay productos disponibles</td></tr>
    <% } else { %>
      <% productos.forEach(p => { %>
        <tr>
          <td><%= p.nombre %></td>
          <td>$<%= p.precio.toFixed(2) %></td>
          <td><%= p.stock %></td>
          <td><%= p.categoria %></td>

          <!-- Mostrar imagen -->
          <td>
            <img src="/images/<%= p.imagen || 'default_producto.png' %>"
                 alt="imagen"
                 style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
          </td>

          <td>
            <% if (p.stock > 0) { %>
              <form data-precio="<%= p.precio %>" data-stock="<%= p.stock %>" class="form-comprar d-flex" action="/usuario/comprar" method="POST" style="gap:.5rem;">
                <input type="hidden" name="idProducto" value="<%= p._id %>">
                <input type="number" name="cantidad" min="1" max="<%= p.stock %>" value="1" class="form-control form-control-sm cantidad-input" style="width:80px;">
                <div class="me-2 d-flex align-items-center">
                  <small class="text-muted me-2">Total:</small>
                  <strong class="total-badge">$<span class="total-val"><%= p.precio.toFixed(2) %></span></strong>
                </div>
                <button type="submit" class="btn btn-success btn-sm">Comprar</button>
              </form>
            <% } else { %>
              <span class="text-danger">Sin stock</span>
            <% } %>
          </td>
        </tr>
      <% }) %>
    <% } %>
  </tbody>
</table>

<%- include("templates/footer") %>
